pipeline {
    agent any

    environment {
        FRONTEND_SSH = 'ssh-frontend' // ID du credential SSH pour le front
        FRONTEND_HOST = '172.16.0.156' // IP de la VM Apache
        FRONTEND_USER = 'user'   // user SSH
    }
stages {
        stage('Checkout') {
            steps {
                echo "ğŸ“¥ Clonage du projet Git"
                git branch: 'exercice5-coralie', url: 'https://github.com/t>
            }
        }

        stage('Setup Python') {
            steps {
                sh '''
                    python3 -m venv venv
                    echo "âš¡ Activation du venv"
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r backend/requirements.txt
                    pip install pytest pytest-html pytest-cov flask-cors
                '''
            }
        }

        stage('Tests') {
            steps {
                sh '''
                    . venv/bin/activate
                    pytest backend/ --junitxml=results.xml
                '''
            }
            post {
                always {
                    junit 'results.xml'
                }
            }
        }
        stage('Build Backend') {
            when {
                expression { currentBuild.result == null || currentBuild.re>
            }
            steps {
                sh '''
                    echo "ğŸ“¦ Packaging backend"
                    mkdir -p build
                    zip -r build/backend.zip backend
                '''
                archiveArtifacts artifacts: 'build/backend.zip'
            }
        }

        stage('Build Frontend') {
            when {
                expression { currentBuild.result == null || currentBuild.re>
            }
            steps {
                sh '''
                    echo "ğŸ“¦ Packaging frontend"
                    mkdir -p build
                    zip -r build/frontend.zip frontend
                '''
                archiveArtifacts artifacts: 'build/frontend.zip'
            }
        }

        stage('Deploy Frontend') {
            when {
                expression { currentBuild.result == null || currentBuild.re>
            }
            steps {
                sshagent([env.FRONTEND_SSH]) {
                    sh """
                        echo "ğŸš€ DÃ©ploiement frontend sur ${FRONTEND_HOST}"
                        scp build/frontend.zip ${FRONTEND_USER}@${FRONTEND_>
                        ssh ${FRONTEND_USER}@${FRONTEND_HOST} 'unzip -o /tm>
                    """
                }
            }
        }

        stage('Deploy Backend') {
            when {
                expression { currentBuild.result == null || currentBuild.re>
            }
            steps {
                sh '''
                    echo "ğŸš€ DÃ©ploiement backend (local ou VM Jenkins)"
                    unzip -o build/backend.zip -d /opt/backend/
                '''
                // Ici tu peux ajouter le restart de service si tu as un se>
                // sh 'systemctl restart backend.service'
            }
        }
    }

    post {
        always { echo "ğŸ§¹ Pipeline terminÃ©e" }
        success { echo "ğŸ‰ Pipeline rÃ©ussie!" }
        failure { echo "âŒ Ã‰chec de la pipeline" }
    }
}
