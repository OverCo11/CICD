pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Clonage du projet Python'
                git branch: 'main', url: 'https://github.com/tom-dab/cicd-project.git'
            }
        }

        stage('Setup Virtualenv & Dependencies') {
            steps {
                sh '''
                    echo "üîß Cr√©ation d'un environnement virtuel"
                    python3 -m venv venv

                    echo "‚ö° Activation du venv"
                    . venv/bin/activate

                    echo "üì¶ Mise √† jour de pip"
                    pip install --upgrade pip

                    echo "üì¶ Installation des d√©pendances du projet"
                    if [ -f "backend/requirements.txt" ]; then
                        pip install -r backend/requirements.txt
                    fi

                    # Installation des d√©pendances manquantes et plugins pytest
                    pip install flask-cors pytest-html pytest-cov

                    echo "‚úÖ D√©pendances install√©es"
                    pip list
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    echo "üß™ Ex√©cution des tests Python"
                    . venv/bin/activate
                    export PYTHONPATH="${PYTHONPATH}:${PWD}/backend"

                    pytest -v \
                        --junitxml=results.xml \
                        --html=report.html \
                        --self-contained-html \
                        --cov=backend \
                        --cov-report=html \
                        --cov-report=term \
                        backend/ || echo "Tests termin√©s avec erreurs"

                    echo "üìä R√©sultats g√©n√©r√©s:"
                    ls -la results.xml report.html htmlcov/ 2>/dev/null || echo "Certains rapports manquants"
                '''
            }

            post {
                always {
                    script {
                        if (fileExists('results.xml')) {
                            junit 'results.xml'
                        }
                        if (fileExists('report.html')) {
                            archiveArtifacts artifacts: 'report.html'
                        }
                        if (fileExists('htmlcov/index.html')) {
                            archiveArtifacts artifacts: 'htmlcov/**/*'
                        }
                    }
                }
            }
        }

        stage('Test Results Summary') {
            steps {
                sh '''
                    if [ -f "results.xml" ]; then
                        tests=$(grep -o 'tests="[^"]*"' results.xml | cut -d'"' -f2)
                        failures=$(grep -o 'failures="[^"]*"' results.xml | cut -d'"' -f2)
                        errors=$(grep -o 'errors="[^"]*"' results.xml | cut -d'"' -f2)

                        echo "üìà Total tests: ${tests:-0}"
                        echo "√âchecs: ${failures:-0}"
                        echo "Erreurs: ${errors:-0}"
                        echo "Succ√®s: $((${tests:-0} - ${failures:-0} - ${errors:-0}))"

                        if [ "${failures:-0}" -eq 0 ] && [ "${errors:-0}" -eq 0 ]; then
                            echo "‚úÖ TOUS LES TESTS SONT PASS√âS"
                        else
                            echo "‚ùå DES TESTS ONT √âCHOU√â"
                        fi
                    else
                        echo "‚ùå Aucun rapport de test trouv√©"
                    fi
                '''
            }
        }
    }

    post {
        always { echo 'üßπ Nettoyage termin√©' }
        success { echo 'üéâ Pipeline Python r√©ussie!' }
        failure { echo '‚ùå √âchec de la pipeline Python' }
        unstable { echo '‚ö†Ô∏è Pipeline instable' }
    }
}
